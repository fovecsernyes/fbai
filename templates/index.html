<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Flappy Bird AI learning</title>
    <script type=text/javascript src="{{url_for('static', filename='jquery.min.js') }}"></script>
</head>
<body>
    <!-- ********** HTML FORM BEGIN ********** -->
<form action="/" method = "POST">
    Gravity:
        <select name=gravity id="gra_dd"></select>
    Population:
        <select name=population id="pop_dd"></select>
    Gap:
        <select name=gap id="gap_dd"></select>
    Distance:
        <select name=distance id="dis_dd"></select>

    <input id="apply" type="submit" formmethod="POST" value="Apply" action="/"/>
    <input id="start" type="button" value="Start" />
    <input type="button" value="Reload" onClick="window.location.href=window.location.href">
    
</form>

<canvas id="canvas" width="576" height="512"></canvas>

<script>
    var cvs = document.getElementById("canvas");
    var ctx = cvs.getContext("2d");
    
    function dropdown(begin, end, add){
        var options = "";
        for(var i=begin; i<=end; i=i+add){
            options += "<option>"+ i +"</option>";
        }
        return options;
        // ********** HTML FORM END ********** -->
        }
        function start_gen(){
                $.ajax({
                    type: "POST",
                    url: "/startgen",
                    contentType: "application/json",
                    data: JSON.stringify( {"request" : "startgen"} ),
                    dataType: "json",
                    async: false,
                    success: function(response) {
                        console.log(response);
                        rungame(response);
                    },
                    error: function(err) {
                        console.log(err || 'Error!');
                    }
                });
        }
        //********** GAME MODUL START **********//

        var gravity = parseInt("{{gravity}}")/5;
        var population = parseInt("{{population}}");
        var gap = parseInt("{{gap}}");
        var distance = 288 - parseInt("{{distance}}");

        var LoadImages = function () {
            bg = new Image();
            fg = new Image();
            welcome = new Image();

            bg.src = "../static/images/bg.png";
            fg.src = "../static/images/fg.png";
            welcome.src="../static/images/welcome.png"

            bird = new Image();
            pipeNorth = new Image();
            pipeSouth = new Image();
            bird.src = "../static/images/bird.png";
            pipeNorth.src = "../static/images/pipeNorth.png";
            pipeSouth.src = "../static/images/pipeSouth.png";

            return self;
        }

        var Bird = function () {
            var self = {
                bX: 10,
                bY: 150,
                fitness: 0,
                alive: true
            }

            self.update = function () {
                self.fitness++;
                self.bY += gravity;
                if (Math.floor(18 * Math.random()) % 18 === 0) {
                    self.moveUp();
                }
            }

            self.moveUp = function () {
                self.bY -= 25;
            }

            self.kill = function () {
                self.alive = false;
            }

            return self;
        }

        var Pipe = function (y) {
            var self =
            {
                pX: cvs.width/2,
                pY: y
            }

            self.update = function () {
                self.pX--;
            }
            return self;
        }

        var Game = function (response) {
            var img = LoadImages();

            var pipe = [];
            pipe[0] = Pipe(0);
            alive = population;

            var bird = [];
            for (var i = 0; i < population; i++) {
                bird[i] = Bird();
            }

            self.update = function () {
                ctx.drawImage(img.bg, 0, 0);
                for (var i = 0; i < pipe.length; i++) {
                    if (pipe[i].pX < 0 - img.pipeNorth.width) {
                        pipe.shift();
                    }
                    
                    constant = img.pipeNorth.height + gap;
                    ctx.drawImage(img.pipeNorth, pipe[i].pX, pipe[i].pY);
                    ctx.drawImage(img.pipeSouth, pipe[i].pX, pipe[i].pY + constant);
                    
                    ctx.drawImage(img.welcome, canvas.width/2, 0);
                    
                    pipe[i].update();

                    if (pipe[i].pX == distance) {
                        pipe.push(Pipe(Math.floor(Math.random() * img.pipeNorth.height) - img.pipeNorth.height));
                    }

                }
                ctx.drawImage(img.fg, 0, cvs.height - img.fg.height);

                ctx.fillStyle="blue";
                ctx.font="12px Monospace";
                ctx.textAlign = "left";
                ctx.fillText(response["generation"] + ". GENERATION", cvs.width/2 + 20, 10);

                for (var i = 0; i < bird.length; i++) {
                    if (bird[i].alive) {
                        ctx.drawImage(img.bird, bird[i].bX, bird[i].bY);
                        bird[i].update();
                        for (var j = 0; j < pipe.length; j++) {
                            if (bird[i].bX + img.bird.width >= pipe[j].pX && bird[i].bX <= pipe[j].pX + img.pipeNorth.width && (bird[i].bY <= pipe[j].pY + img.pipeNorth.height || bird[i].bY + img.bird.height >= pipe[j].pY + constant) || bird[i].bY + img.bird.height >= cvs.height - fg.height) {
                                bird[i].kill();
                                alive--;
                            }
                        }
                    }
                    var c = i + 1;
                    if (c < 10 ){
                        c = "0" + c;
                    }
                    ctx.font="12px Monospace";
                    ctx.textAlign = "left";
                    if(bird[i].alive){
                        ctx.fillStyle="black";
                    }else{
                        ctx.fillStyle= "red";
                    }
                    ctx.fillText(c + ". fitness: " + bird[i].fitness, cvs.width/2 + 20, 20 + i*10);
                    ctx.beginPath();
                    ctx.moveTo(cvs.width/2,0);
                    ctx.lineTo(cvs.width/2,cvs.height);
                    ctx.stroke();
                }
                if (alive > 0) {
                    requestAnimationFrame(update);
                }else{
                    $.ajax({
                            type: "POST",
                            url: "/finishgen",
                            contentType: "application/json",
                            data: JSON.stringify( {"request" : "finishgen"} ),
                            dataType: "json",
                            async: false,
                            success: function(response) {
                                console.log(response);
                                start_gen();
                            },
                            error: function(err) {
                                console.log(err || 'Error!');
                            }
                        });
                }
            }
            return self;
        }

        function rungame(response){
            var game = Game(response);
            game.update();
        }
    //********** GAME MODUL END **********//


    //********** WELCOME SCREEN BEGIN **********//
    window.onload = function() {
        document.getElementById("gra_dd").innerHTML = dropdown(1,10,1);
        document.getElementById("pop_dd").innerHTML = dropdown(5,50,5);
        document.getElementById("gap_dd").innerHTML = dropdown(70,120,5);
        document.getElementById("dis_dd").innerHTML = dropdown(120,260,20);

        $('#gra_dd').val("6");
        $('#pop_dd').val("50");
        $('#gap_dd').val("120");
        $('#dis_dd').val("160");

        var bg = new Image();
        bg.addEventListener('load', function() {
            //background
            ctx.drawImage(bg,0,0);
            //welcome
            ctx.font = "20px Monospace";
            ctx.fillStyle = 'white';
            ctx.textAlign = "center";
            ctx.fillText("Welcome!", cvs.width/2, 100);
            //description
            ctx.font = "15px Monospace";
            ctx.fillStyle = 'black';
            ctx.fillText("This program will learn to play Flappy Bird.", cvs.width/2, 150);
            ctx.fillText("Set the running parameters below, then click Start!", cvs.width/2, 175);
            //details
            ctx.font = "10px Monospace";
            ctx.fillStyle = "grey";
            ctx.fillText("This is not the original game, just a reimplemented version based on the original Flappy Bird.", cvs.width/2, cvs.height - 20);
            ctx.fillText("Created by MV with the help of HB.", cvs.width/2, cvs.height - 10);

            document.getElementById("start").disabled = true;
            if ( "{{database_status}}" == "OK"){
                $('#gra_dd').val("{{gravity}}")
                $('#pop_dd').val("{{population}}")
                $('#gap_dd').val("{{gap}}")
                $('#dis_dd').val("{{distance}}")

                document.getElementById("apply").disabled = true;
                document.getElementById("start").disabled = false;
                document.getElementById("gra_dd").disabled = true;
                document.getElementById("pop_dd").disabled = true;
                document.getElementById("gap_dd").disabled = true;
                document.getElementById("dis_dd").disabled = true;
            }
        }, false);
        bg.src = "../static/images/welcome.png";


        document.getElementById("start").addEventListener("click", function(){
            document.getElementById("start").disabled = true;
            $.ajax({
                type: "POST",
                url: "/start",
                contentType: "application/json",
                data: JSON.stringify( {"request" : "start"} ),
                dataType: "json",
                async: false,
                success: function(response) {
                    start_gen();
                },
                error: function(err) {
                    console.log(err || 'Error!');
                }
            });                
        });
        
    }
    //********** WELCOME SCREEN END **********//
</script>


</body>
</html>